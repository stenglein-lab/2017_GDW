# Mapping and Assembly

## In this exercise, we will de novo assemble a viral genome from a publically available dataset and will use read mapping to validate our assembly.  We will:

* Download a dataset from the SRA
* Convert the dataset from SRA -> FASTQ format
* Find and download a genome sequence from NCBI
* Create a bowtie index from the genome sequence (necessary to map reads to it)
* Map reads in the dataset to the genome 
* De-novo assemble non-mapping reads (to assemble viral genome)
* Map reads to the draft viral genome to validate assembly

Other/todo:

* FASTQC
* read trimming
* QUAST


---

### Download an SRA dataset

First, we want to download a dataset to play with.

We will download this dataset from the NCBI Short Read Archive (SRA) database: 

https://www.ncbi.nlm.nih.gov/sra/?term=ERR1938563

This dataset was generated by researchers at the Swedish University of Agricultural Sciences, and is not yet associated with a publication on pubmed.  Here is the abstract from SRA:

> Adenoviruses have a wide host range and are common pathogens in vertebrates but have only rarely been detected and correlated with disease in cetaceans. A novel adenovirus, named Bottlenose dolphin adenovirus 1 (BdAdV-1), was detected in captive bottlenose dolphin (Tursiops truncatus) suffering from self-limiting gastroenteritis. Adenovirus was identified both in feces and in supernatant from infected HeLa cells. The complete genome of BdAdV-1 was recovered from data generated by MiSeq and the sequence was validated by Sanger sequencing. The genome is 34 080 bp and has an ITR of 220 bp. A total of 30 coding sequences were identified and 26 were functionally annotated. Among the unusual features of this genome, we observed three hypothetical proteins and an E3 region without any similarity with known once. The fiber protein has not more than 25% identity with adenoviruses described in other species.

First, let's setup a directory (folder) in which to work.  Open the terminal app on your laptop and type these commands:

change (move) to your home directory, if not already there
```
cd
```

make a new directory
```
mkdir gdw_working
```

move to that directory
```
cd gdw_working    
```

double check you are in the directory you think you are:
```
pwd   
```

To get the dataset, we will use the fastq-dump tool, part of the [SRA toolkit](https://www.ncbi.nlm.nih.gov/books/NBK158900/).

To run fasta-dump, you just need to specify the run # (SRR# or ERR#) of the dataset you want.  Our run # is ERR1938563

The --split-files option of the command will create separate, synchronized files for paired reads 

```
fastq-dump ERR1938563 --split-files
```

Confirm that you downloaded the files.  You should see files named ERR1938563_1.fastq and ERR1938563_2.fastq 

```
ls -lh
```

Have a look at the first 20 lines of the fastq files using the head command
```
head -20 ERR1938563_1.fastq ERR1938563_2.fastq 
```




### Download the dolphin genome

We are going to map the reads in our dataset to the dolphin genome.  First, we need to *find* the dolphin genome.  As usual, there are few ways we could go about this:

1. Navigate through the NCBI [Genome database](https://www.ncbi.nlm.nih.gov/genome/)
2. Navigate through another genome database, like [Ensembl](http://www.ensembl.org/index.html) or [UCSC](https://genome.ucsc.edu/) 
3. Google 'dolphin genome sequence'  (not a terrible way to do it)

We will go through the NCBI Genome database.  Navigate to:

https://www.ncbi.nlm.nih.gov/genome/

Search for `dolphin`.  Scroll down until you see the record for *Tursiops truncatus* (the bottlenosed dolphin).  Click on that link.

From this overview page, there are a number of paths to the actual genome sequence.  One of these is at the top of the page, where there are links to download sequences in FASTA format.  Hover over the link to download the genome sequence in FASTA format.  Note that this link points to this URL:

ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/151/865/GCF_000151865.2_Ttru_1.4/GCF_000151865.2_Ttru_1.4_genomic.fna.gz

This is an FTP link, meaning that we can download this file directly from the command line using a utility like [curl](https://en.wikipedia.org/wiki/CURL):

make sure you're in the right directory:
```
cd ~/gdw_working
```

download the dolphin genome sequence using the curl utility
```
curl -O ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/151/865/GCF_000151865.2_Ttru_1.4/GCF_000151865.2_Ttru_1.4_genomic.fna.gz
```

** We don't actually want to continue this with the whole genome sequence because it will take a long time to download and index **

Press `ctrl-C` on your keyboard to cancel the curl download


* 10 minutes over a DSL line*

confirm you've downloaded the genome sequence
you should see a file named GCF_000151865.2_Ttru_1.4_genomic.fna.gz 
```
ls -lh 
```

the .gz file extension means this file is gzipped (compressed)
decompress it using gunzip
```
gunzip GCF_000151865.2_Ttru_1.4_genomic.fna.gz 
```

* 1 minute on macbook *

the file should now be named GCF_000151865.2_Ttru_1.4_genomic.fna
```
ls -lh
```

Note that the file went from ~700 Mb to ~2.4 Gb after decompression.  

### Download the dolphin mitochondrial genome

** We could align reads to the entire dolphin genome, but that would take a time longer than we have for this workshop **
** Instead, we'll align reads to the dolphin mtDNA genome **

Return to the NCBI Genome bottlenosed dolphin page:

https://www.ncbi.nlm.nih.gov/genome/769

Under the Replicon Info section, note the link to the mitochondrial genome: NC_012059.1   Click that link to go to the Genbank nucleotide record for this genome.

#### As is usually the case in bioinformatics, there is more than one way to do what we want:

* Option 1: Download from website using browser
  * Send->complete record->file->format[fasta]
  * Move this FASTA file to your ~/gdw_working directory using the Finder or the command line

* Option 2: download the sequence in Geneious.
  * Copy the accession # from your browswer page.
  * Open Geneious.  Goto the NCBI->Nucleotide section.
  * Search for the accession: NC_012059.1  
  * Create a new folder in Geneious.
  * Drag the mtDNA sequence to this new folder.
  * Note the nice annotation.
  * Export the sequence in FASTA format.  File->Export->Selected Documents->Fasta sequences/alignment format.  Click through options.


### Create a bowtie index of the dolphin mtDNA genome

Now we will create a bowtie2 index from our dolphin mitochondrial genome sequence.  Indexing pre-processes a sequence to make it faster to map to later.

In your terminal window run these commands:

Confirm that the fasta file is there
You should see a file named:  NC_012059.fasta that is ~16 kb
```
ls -lh    
```

[bowtie2-build](http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml#the-bowtie2-build-indexer) is the command you'll use to make the index
this command takes 2 arguments: 
(1) the name of the fasta file containing the sequence(s) you will index
(2) the name of the index (can be whatever you want)

```
bowtie2-build NC_012059.fasta dolphin_mtDNA_bt_index 
```
* 1 sec on macbook *

confirm that you built the index.  You should see a bunch of files named ending in bt2, like dolphin_mtDNA_bt_index.3.bt2
```
ls -lh
```



#### Map reads to dolphin mtDNA genome

[Bowtie2](http://www.nature.com/nmeth/journal/v9/n4/full/nmeth.1923.html) was developed as a fast short-read mapper.  It aligns short NGS reads to a reference sequence.  Bowtie2 has a nice [manual](http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml) that explains how to use it and what the various parameters mean.

Note that there are a variety of other good read mapping tools, including [HiSat](https://ccb.jhu.edu/software/hisat2/index.shtml), [gmap/gsnap](http://research-pub.gene.com/gmap/), and [STAR](https://github.com/alexdobin/STAR).

To align reads with bowtie2, we need:

1. our reads, in FASTQ format  (or FASTA)
2. the index

Run bowtie2 like this:

```
bowtie2 -x dolphin_mtDNA_bt_index -q -1 ERR1938563_1.fastq  -2 ERR1938563_2.fastq --no-unal --threads 4 -S ERR193863_mapped_to_NC012059.sam
```

Let's deconstruct this command line a little
Note that everything after the `#` characters is a comment
```
bowtie2                     # name of the command
-x dolphin_mtDNA_bt_index   # name of the index
-q                          # reads are in FASTQ format 
-1  ERR1938563_1.fastq      # name of 1st read of pair FASTQ file  
-2  ERR1938563_2.fastq      # name of 2nd read of pair FASTQ file  
--no-unal                   # don't output unmapped reads to the SAM output file (will make it _much_ smaller
--threads 4                 # since our computers have multiple processers, run on 4 to go faster
-S ERR193863_mapped_to_NC012059.sam           #  The name of the output file in SAM format ()
```

The output file ERR193863_mapped_to_NC012059.sam is in [SAM format](https://en.wikipedia.org/wiki/SAM_(file_format)).  This is a plain text format, so you can look at the first 20 lines by running this command:

```
head -20 ERR193863_mapped_to_NC012059
```



#### Create a bowtie index of the dolphin genome

Now we will create a bowtie2 index from our dolphin genome sequence.  Indexing pre-processes a sequence to make it faster to map to later.

In your terminal window run these commands:

confirm that the fasta file is there
```
ls -lh    # should see: NC_007398.fasta
```

run bowtie2-build to make index
this command takes 2 arguments: 
(1) the name of the fasta file containing the sequence(s) you will index
(2) the name of the index (can be whatever you want)

```
bowtie2-build NC_007398.fasta NC_007398
```

confirm that you built the index.  You should see a bunch of files named ending in bt2, like NC_007398.3.bt2
```
ls -lh
```







#### De-novo assembly of non-mapping reads






## Download the boa constrictor (mtDNA) genome.

The dataset we downloaded is from boa constrictor liver RNA.  We are going to map the reads in the dataset to the boa constrictor mtDNA genome sequence to demonstrate read mapping.  We'll use the [bowtie2](http://bowtie-bio.sourceforge.net/bowtie2/index.shtml) mapper.

#### First we need to actually get the genome sequence to which we will map:

* Goto NCBI Taxonomy database: https://www.ncbi.nlm.nih.gov/taxonomy
* Search for "boa constrictor"
* Click on boa constrictor link
* Click on genome (1) link
*
* Click on 'See also 1 organelle- and plasmid-only records matching your search/
* Click on 'NC_007398.1' RefSeq link

#### As is usually the case in bioinformatics, there is more than one way to do what we want:

* Option 1: Download from website using browser
  * download sequence from NCBI website
  * Send->complete record->file->format[fasta]
  * Move this FASTA file to your ~/boa_sra directory using the Finder or the command line

* Option 2: download the sequence in Geneious.  
  * Copy the accession # from your browswer page.  
  * Open Geneious.  Goto the NCBI->Nucleotide section.  
  * Search for the accession (NC_007398.1) .  
  * Create a new folder in Geneious.  
  * Drag the boa mtDNA sequence to this new folder.
  * Note the nice annotation.
  * Export the sequence in FASTA format.  File->Export->Selected Documents->Fasta sequences/alignment format.  Click through options.  

#### Create a bowtie index

Now we will create a bowtie2 index from our boa mtDNA sequence.  Indexing pre-processes a sequence to make it faster to map to later.

In your terminal window run these commands:

```
# confirm that the fasta file is there
ls -lh    # should see: NC_007398.fasta

# run bowtie2-build to make index
# this command takes 2 arguments: 
# (1) the name of the fasta file containing the sequence(s) you will index
# (2) the name of the index (can be whatever you want)

bowtie2-build NC_007398.fasta NC_007398

# confirm that you built the index.  You should see a bunch of files named ending in bt2, like NC_007398.3.bt2
ls -lh
```

#### Mapping reads in our dataset to the bowtie index
